# 프로세스 주소 공간 (Process Address Space)

![image](https://github.com/amazinguss/cs_study/assets/103317018/5f55cd58-e2c9-4d81-8d31-56ee73b5961b)

프로세스 주소 공간을 이해하기에 앞서 알아야 할 용어들과 프로세스 실행 과정이 있다.

### 용어
* `로더` – PE 파일 또는 DLL 파일(이미지파일)을 입력으로 받아 메모리에 로드하여 실행하는 운영 체제의 프로그램.
* `이미지 파일` – 실행 파일을 메모리에 로드하고 실행할 준비를 위해 디스크에 저장된 프로그램의 이미지. 로더는 이미지를 메모리에 로드하고 실행한다.
* `프로세스` – 로더 에 의해 로드된 후 실행 중인 이미지 파일 의 인스턴스이자, 운영체제가 자원을 할당하는 단위.
* `메모리` – 컴퓨터에서 정보를 일시적으로 저장하는 장치로, RAM을 의미한다. 메모리에 로드되어야 CPU가 그 프로세스의 명령을 실행할 수 있고, 메모리는 실행 중인 프로그램의 '작업 공간'과 같다. 

### 프로세스 실행과정
1. **이미지 파일 로딩**: 프로그램 코드(이미지 파일)가 메모리에 로드되며, 이 과정에서 프로세스가 생성된다. 이미지 파일에는 함수와 변수 등의 **심볼**이 포함되어 있으며, 이들은 메모리의 특정 주소에 할당된다.
2. **변수 및 함수 사용**: 프로세스는 실행 과정에서 여러 변수와 함수를 사용한다. 예를 들어, 프로세스가 변수에 값을 저장하거나 함수를 호출하는 경우, 이 변수나 함수는 각각 특정 메모리 주소에 위치하게 된다.
3. **CPU의 역할**: CPU는 프로그램의 명령을 실행하는 역할을 한다. 이때, CPU는 필요한 데이터가 저장된 메모리 주소에 접근한다. 예를 들어, 변수의 값을 변경하는 명령이 있는 경우, CPU는 그 변수가 저장된 메모리 주소에 접근하여 해당 값으로 업데이트한다. 함수를 호출하는 경우, CPU는 함수의 시작 주소로 점프하고 해당 함수를 실행한다.

</br>

주소공간이란 프로세스가 메모리에서 사용할 수 있는 주소의 범위를 의미햔다. 
> 예) 프로세스1의 주소 공간 : 프로세스 1이 사용할 수 있는 메모리 주소들의 집합 (메모리 주소1 ~ 메모리 주소6)

이는 각 프로세스가 사용하는 변수, 함수 등의 정보를 저장하기 위한 공간으로 이해하면 된다. </br>
예를 들어, 컴퓨터의 메모리가 집이라면, 각 프로세스의 주소 공간은 집 내의 방 하나로 생각할 수 있다. 
각 방은 독립된 공간이며, 방 안에서는 여러 가지 활동(읽기/쓰기/산술 연산 등)을 수행할 수 있습니다. 
또한, 방 안에 있는 물건(변수, 함수 등)을 사용하려면 그 물건의 위치(메모리 주소)를 알아야 한다.

이런 식으로, 각 프로세스는 자신만의 독립된 주소 공간을 가지며, 이 공간 내에서 메모리를 읽거나 쓰거나 다른 연산을 수행한다. (CPU가 수행) </br>
이 주소 공간은 프로세스가 실행되는 동안 필요한 모든 정보(함수, 변수 등)를 저장하는데 사용된다.

# 프로세스 주소 공간 구성
프로세스 주소공간은 아래와 같이 구분된다. 스택과 힙 영역이 상황에 따라 화살표 방향으로 영역을 확장한다.
<img width="746" alt="image" src="https://github.com/amazinguss/cs_study/assets/103317018/71ed10f7-b462-4de9-a4ee-ba3adf0850fb">

## Stack 
함수의 호출과 관계되는 지역변수와 매개변수가 저장되는 영역이다.
Stack 영역의 값은 함수의 호출과 함께 할당되며, 함수의 호출이 완료되면 소멸한다.
메모리의 높은 주소에서 낮은 주소의 방향으로 할당된다.
재귀 함수가 너무 깊게 호출되거나 함수가 지역변수를 너무 많이 가지고 있어 stack 영역을 초과하면 stack overflow 에러가 발생한다.

## Heap
**런타임에 크기가 결정되는 영역**이다. 사용자에 의해 공간이 동적으로 할당 및 해제된다.
주로 참조형 데이터 (ex. 클래스) 등의 데이터가 할당된다.
메모리의 낮은 주소에서 높은 주소의 방향으로 할당된다.

## Data
전역 변수나 Static 변수 등 프로그램이 사용할 수 있는 데이터를 저장하는 영역이다.
어떤 프로그램에 전역/static 변수를 참조하는 코드가 존재한다면, 이 프로그램은 컴파일 된 후에 data 영역을 참조하게 된다.
프로그램의 시작과 함께 할당되며, 프로그램이 종료되면 소멸한다. 단, 초기화 되지 않은 변수가 존재한다면, 이는 (그림에는 표현되지는 않았지만 BSS 영역에 저장된다.)

## Code 
프로그램이 실행될 수 있도록 CPU가 해석 가능한 기계어 코드가 저장되어 있는 공간으로,
프로그램이 수정되면 안 되므로 ReadOnly 상태로 저장 되어있다.
결국 메모리는 한정되어 있기 때문에, 프로세스는 다양한 방법으로 메모리를 절약하려고 시도한다.

> ### 왜 구역을 나눈것인가?
> 최대한 데이터를 공유하여 메모리 사용량을 줄여야 한다.
> Code는 같은 프로그램 자체에서는 모두 같은 내용이기 때문에 따로 관리하여 공유한다.
> Stack과 data를 나눈 이유는, 스택 구조의 특성과 전역 변수의 활용성을 위한 것이다.
> 프로그램의 함수와 지역 변수는, LIFO(가장 나중에 들어간게 먼저 나옴)특성을 가진 스택에서 실행된다.
> 따라서 이 함수들 안에서 공통으로 사용하는 '전역 변수'는 따로 지정해주면 메모리를 아낄 수 있다.

# Virtual address 사용

8비트 컴퓨터나 마이크로 컨트롤러의 경우 CPU가 단 하나의 실행 프로세스만 가지게 되어 프로세스가 모든 데이터가 있는 고정된 주소 공간 세트를 얻을 수 있기 때문에 
위 그림과 같이 복잡한 절차 없이 쉽게 CPU가 RAM에 접근할 수 있었다. 하지만 프로세스가 여러 개인 경우 아래와 같은 문제가 생긴다. </br>

#### 1. 각 프로세스를 메모리에 어떻게 할당할 것인가?
#### 2. 기존 실행되고 있는 프로세스의 데이터를 다른 프로세스가 덮어쓰지 않아야 한다.
#### 3. 주소가 상대적이어야 한다. (절대적 주소는 다른 프로세스가 사용중일 수 있기 때문에)

이러한 문제들을 해결하기 위헤 Virtual address를 사용한다.
<img width="939" alt="image" src="https://github.com/amazinguss/cs_study/assets/103317018/54eb6c01-483b-42d2-b454-634955ec10ae">

APP 이 자신의 virtual address를 주면 CPU의 **MMU(Memory Management Unit)** 에서 해당 virtual address에 매핑된 실제 physical memory address를 반환하여 RAM에 그 주소로 접근한다.

<img width="917" alt="image" src="https://github.com/amazinguss/cs_study/assets/103317018/f4388015-ee4f-436f-8165-10e03703b2a8">

APP1은 0부터 5242880까지의 주소공간을 가지고 있지만 실제 메모리의 5242880 ~ 10485760 까지의 실제 범위를 갖는다. </br>
APP2도 마찬가지로 0부터 5242880까지의 주소공간을 가지고 있지만 실제 메모리의 10485761 부터 해당 크기까지의 범위를 가진다. </br>
이렇게 상대적인 주소를 통해 유연하게 실제 메모리에 주소 범위를 할당할 수 있다.

<img width="931" alt="image" src="https://github.com/amazinguss/cs_study/assets/103317018/f5c4840a-5795-4d57-8206-2b675005b6bd">

이 경우는 APP1이 실행 된 후에 APP2가 실행된 경우이다. </br>
APP1은 2개의 범위로 나뉘어 실제 메모리에서 범위를 나누어 할당받게 되고, APP2는 그 사이에 위치하게 된다.
이러한 방식을 통해, APP은 하나의 연속된 address공간을 가지지 않아도 되고 한 프로세스(APP2)가 다른 프로세스(APP1)의 메모리 공간을 실수로 또는 악의적으로 변경하는 것을 방지할 수 있다. 또한 물리적 메모리의 분산된 부분을 연속적인 메모리 블록처럼 보일 수 있게 하여 프로그램이 메모리를 더 효과적이고 편리하게 사용할 수 있게 한다.

> ### 실제 물리적 메모리가 모두 사용된다면?
> 일부 데이터는 하드 디스크 등의 보조 저장 장치에 임시로 저장되며, 이를 통해 더 큰 메모리 공간을 가진 것처럼 작동할 수 있게 해준다.

참고 : 
* https://velog.io/@klm03025/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%A3%BC%EC%86%8C-%EA%B3%B5%EA%B0%84
* https://tbhaxor.com/understanding-address-spacing-in-detail/


















