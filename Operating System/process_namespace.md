# 프로세스 주소 공간 (Process Address Space)

![image](https://github.com/amazinguss/cs_study/assets/103317018/5f55cd58-e2c9-4d81-8d31-56ee73b5961b)

프로세스 주소 공간을 이해하기에 앞서 알아야 할 용어들이 있다.

> * `로더` – PE 파일 또는 DLL 파일(이미지파일)을 입력으로 받아 메모리에 로드하여 실행하는 운영 체제의 프로그램.
> * `이미지 파일` – 실행 파일을 메모리에 로드하고 실행할 준비를 위해 디스크에 저장된 프로그램의 이미지. 로더는 이미지를 메모리에 로드하고 실행한다.
> * `프로세스` – 로더 에 의해 로드된 후 실행 중인 이미지 파일 의 인스턴스이자, 운영체제가 자원을 할당하는 단위.
> * `메모리` – 컴퓨터에서 정보를 일시적으로 저장하는 장치로, RAM을 의미한다. 메모리에 로드되어야 CPU가 그 프로세스의 명령을 실행할 수 있고, 메모리는 실행 중인 프로그램의 '작업 공간'과 같다. 
>      실행 중인 프로세스와 변수 등을 저장하고 CPU가 접근하고 업데이트할 수 있다.

프로세스가 메모리를 할당 받으면, 자신만의 방법으로 메모리를 관리하기 위해 이 공간들을 어떤 구조로 관리하는데, 우리는 이를 프로세스 주소 공간이라고 부른다.
이미지 파일이 메모리에 로드되면 함수 호출, 로컬 또는 전역 변수의 데이터 처리 등과 같은 메모리 관련 작업이 많이 있다. 
값이 항상 CPU 레지스터에 저장되는 것은 아니기 때문에 작업을 수행하는 동안 이러한 심볼(함수 이름, 변수 이름 등의 프로그램 코드 내의 식별자)의 주소를 알아야 한다. 
그렇기 때문에 메모리의 주소 공간은 모든 읽기/쓰기 또는 산술 연산을 수행할 수 있는 프로세스에 할당된다.

# 프로세스 주소 공간 구성
프로세스 주소공간은 아래와 같이 구분된다. 스택과 힙 영역이 상황에 따라 화살표 방향으로 영역을 확장한다.
<img width="746" alt="image" src="https://github.com/amazinguss/cs_study/assets/103317018/71ed10f7-b462-4de9-a4ee-ba3adf0850fb">

## Stack 
함수의 호출과 관계되는 지역변수와 매개변수가 저장되는 영역이다.
Stack 영역의 값은 함수의 호출과 함께 할당되며, 함수의 호출이 완료되면 소멸한다.
메모리의 높은 주소에서 낮은 주소의 방향으로 할당된다.
재귀 함수가 너무 깊게 호출되거나 함수가 지역변수를 너무 많이 가지고 있어 stack 영역을 초과하면 stack overflow 에러가 발생한다.

## Heap
**런타임에 크기가 결정되는 영역**이다. 사용자에 의해 공간이 동적으로 할당 및 해제된다.
주로 참조형 데이터 (ex. 클래스) 등의 데이터가 할당된다.
메모리의 낮은 주소에서 높은 주소의 방향으로 할당된다.

## Data
전역 변수나 Static 변수 등 프로그램이 사용할 수 있는 데이터를 저장하는 영역이다.
어떤 프로그램에 전역/static 변수를 참조하는 코드가 존재한다면, 이 프로그램은 컴파일 된 후에 data 영역을 참조하게 된다.
프로그램의 시작과 함께 할당되며, 프로그램이 종료되면 소멸한다. 단, 초기화 되지 않은 변수가 존재한다면, 이는 (그림에는 표현되지는 않았지만 BSS 영역에 저장된다.)

## Code 
프로그램이 실행될 수 있도록 CPU가 해석 가능한 기계어 코드가 저장되어 있는 공간으로,
프로그램이 수정되면 안 되므로 ReadOnly 상태로 저장 되어있다.
결국 메모리는 한정되어 있기 때문에, 프로세스는 다양한 방법으로 메모리를 절약하려고 시도한다.

> ### 왜 구역을 나눈것인가?
> 최대한 데이터를 공유하여 메모리 사용량을 줄여야 한다.
> Code는 같은 프로그램 자체에서는 모두 같은 내용이기 때문에 따로 관리하여 공유한다.
> Stack과 data를 나눈 이유는, 스택 구조의 특성과 전역 변수의 활용성을 위한 것이다.
> 프로그램의 함수와 지역 변수는, LIFO(가장 나중에 들어간게 먼저 나옴)특성을 가진 스택에서 실행된다.
> 따라서 이 함수들 안에서 공통으로 사용하는 '전역 변수'는 따로 지정해주면 메모리를 아낄 수 있다.


참고 : 
* https://velog.io/@klm03025/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%A3%BC%EC%86%8C-%EA%B3%B5%EA%B0%84
* https://tbhaxor.com/understanding-address-spacing-in-detail/



